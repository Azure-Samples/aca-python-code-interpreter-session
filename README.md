# Azure Container Apps with Semantic Kernel Sessions

This project demonstrates how to use Azure Container Apps dynamic sessions with Semantic Kernel to create an AI agent capable of performing code interpretation and calculations.

## Overview

The application is a FastAPI-based web API that accepts user input and returns responses generated by a Semantic Kernel AI agent. The agent uses Azure OpenAI for language processing and Azure Container Apps sessions for code interpretation.

## Features

- **Semantic Kernel Integration**: Uses Microsoft's Semantic Kernel framework for AI agent development
- **Code Interpretation**: Leverages Azure Container Apps dynamic sessions for executing Python code
- **Azure OpenAI**: Integrates with Azure OpenAI services for natural language processing
- **FastAPI Web API**: Provides a RESTful interface for interaction
- **Container Ready**: Includes Docker configuration for containerization

## Prerequisites

- Python 3.10 or later
- Azure subscription with active account
- Azure CLI installed and configured
- [Azure Developer CLI (azd)](https://learn.microsoft.com/azure/developer/azure-developer-cli/install-azd) installed
- Git

## Quick Start with Azure Developer CLI (azd)

The easiest way to deploy this application is using the Azure Developer CLI (azd):

### 1. Initialize and Deploy

```bash
# Clone the repository
git clone <your-repo-url>
cd aca-python-code-interpreter-session

# Login to Azure
azd auth login

# Initialize the project (first time only)
azd init

# Deploy to Azure (provisions resources and deploys the app)
azd up
```

The `azd up` command will:
- Create a new resource group
- Deploy Azure OpenAI service with GPT-3.5 Turbo model
- Create Azure Container Apps session pool for Python code execution
- Deploy the FastAPI application to Azure Container Apps
- Configure managed identity and permissions automatically

### 2. Access Your Application

After deployment, azd will provide you with:
- **Application URL**: Access your chat interface at `/ui`
- **API Documentation**: View API docs at `/docs`
- **Environment Details**: See resource details with `azd show`

### 3. Manage Your Deployment

```bash
# View deployment status and URLs
azd show

# Redeploy after code changes
azd deploy

# View logs
azd logs

# Clean up resources
azd down
```

## Local Development

### 1. Setup Environment

```bash
# Create virtual environment
python -m venv .venv

# Activate virtual environment
# Windows:
.venv\Scripts\activate
# Linux/macOS:
source .venv/bin/activate

# Install dependencies
pip install -r requirements.txt
```

### 2. Configure Environment Variables

Copy `.env.sample` to `.env` and configure:

```env
AZURE_OPENAI_ENDPOINT=<your-azure-openai-endpoint>
POOL_MANAGEMENT_ENDPOINT=<your-session-pool-management-endpoint>
```

### 3. Run Locally

```bash
fastapi dev main.py
```

Access the application at:
- **Chat Interface**: http://localhost:8000/ui
- **API Documentation**: http://localhost:8000/docs

## Manual Azure Deployment (Alternative)

If you prefer manual deployment without azd, you can use Azure CLI:

### Create Azure Resources

```bash
# Set variables
RESOURCE_GROUP_NAME=aca-sessions-tutorial
AZURE_OPENAI_LOCATION=swedencentral
AZURE_OPENAI_NAME=<UNIQUE_OPEN_AI_NAME>
SESSION_POOL_LOCATION=eastasia
SESSION_POOL_NAME=code-interpreter-pool

# Create resource group
az group create --name $RESOURCE_GROUP_NAME --location $SESSION_POOL_LOCATION

# Create Azure OpenAI service
az cognitiveservices account create \
    --name $AZURE_OPENAI_NAME \
    --resource-group $RESOURCE_GROUP_NAME \
    --location $AZURE_OPENAI_LOCATION \
    --kind OpenAI \
    --sku s0 \
    --custom-domain $AZURE_OPENAI_NAME

# Deploy GPT-3.5 Turbo model
az cognitiveservices account deployment create \
    --resource-group $RESOURCE_GROUP_NAME \
    --name $AZURE_OPENAI_NAME \
    --deployment-name gpt-35-turbo \
    --model-name gpt-35-turbo \
    --model-version "1106" \
    --model-format OpenAI \
    --sku-capacity "100" \
    --sku-name "Standard"

# Create session pool
az containerapp sessionpool create \
    --name $SESSION_POOL_NAME \
    --resource-group $RESOURCE_GROUP_NAME \
    --location $SESSION_POOL_LOCATION \
    --max-sessions 100 \
    --container-type PythonLTS \
    --cooldown-period 300

# Deploy application
ENVIRONMENT_NAME=aca-sessions-tutorial-env
CONTAINER_APP_NAME=chat-api

az containerapp up \
    --name $CONTAINER_APP_NAME \
    --resource-group $RESOURCE_GROUP_NAME \
    --location $SESSION_POOL_LOCATION \
    --environment $ENVIRONMENT_NAME \
    --env-vars "AZURE_OPENAI_ENDPOINT=<OPEN_AI_ENDPOINT>" "POOL_MANAGEMENT_ENDPOINT=<SESSION_POOL_MANAGEMENT_ENDPOINT>" \
    --source .
```

**Note**: Configure managed identity and permissions as described in the [Azure Container Apps Sessions Tutorial](https://learn.microsoft.com/en-us/azure/container-apps/sessions-tutorial-semantic-kernel).

## API Usage

### Chat Endpoint

**GET** `/chat?message=<your-message>`

Example:

```bash
GET /chat?message=What time is it right now?
```

Response:

```json
{
  "output": "The current time is 2024-01-15 14:30:25 UTC"
}
```

### Interactive Web Interface

Visit `/ui` for a web-based chat interface that demonstrates:

- Math questions automatically trigger Python code execution
- Regular questions get conversational AI responses
- Session tracking for debugging and monitoring

## Key Components

### Semantic Kernel Agent

- Uses Azure OpenAI for natural language understanding
- Integrates with Azure Container Apps sessions for code execution
- Supports function calling for complex calculations

### Sessions Python Tool

- Provides code interpretation capabilities
- Executes Python code in secure, isolated sessions
- Maintains session state across multiple interactions

### Authentication

- Uses Azure DefaultAzureCredential for authentication
- Supports both local development and Azure deployment scenarios

## Troubleshooting

### Common Issues

1. **Authentication Errors**: Ensure proper role assignments for Azure services
2. **Environment Variables**: Verify all required environment variables are set
3. **Python Version**: Use Python 3.10 or later for compatibility

### Required Azure Roles

- **Cognitive Services OpenAI User**: For Azure OpenAI access
- **Azure ContainerApps Session Executor**: For session pool access

## License

This project is licensed under the MIT License - see the LICENSE file for details.

## References

- [Azure Container Apps Sessions Tutorial](https://learn.microsoft.com/en-us/azure/container-apps/sessions-tutorial-semantic-kernel)
- [Azure Developer CLI Documentation](https://learn.microsoft.com/azure/developer/azure-developer-cli/)
- [Semantic Kernel Documentation](https://learn.microsoft.com/en-us/semantic-kernel/)
- [Azure Container Apps Documentation](https://learn.microsoft.com/en-us/azure/container-apps/)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
